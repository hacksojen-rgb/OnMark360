name: üöÄ Auto Deploy to cPanel

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: üéâ Build & Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: üöö Get latest code
      uses: actions/checkout@v4

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üì¶ Install Dependencies
      run: npm ci

    - name: üèóÔ∏è Build Frontend
      run: npm run build

    - name: üìÇ Prepare Files for Deployment
      run: |
        mkdir temp_deploy
        
        # ‡ßß. ‡¶´‡ßç‡¶∞‡¶®‡ßç‡¶ü‡¶è‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶¨‡¶ø‡¶≤‡ßç‡¶° ‡¶´‡¶æ‡¶á‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã (dist ‡¶•‡ßá‡¶ï‡ßá) ‡¶∞‡ßÅ‡¶ü‡ßá ‡¶Ü‡¶®‡¶æ
        cp -r dist/* temp_deploy/
        
        # ‡ß®. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
        mkdir -p temp_deploy/admin
        mkdir -p temp_deploy/api
        mkdir -p temp_deploy/uploads
        
        # ‡ß©. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶° ‡¶´‡¶æ‡¶á‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ (‡¶∞‡ßÅ‡¶ü‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá)
        # ‡¶Ü‡¶ó‡ßá 'src/admin' ‡¶õ‡¶ø‡¶≤, ‡¶è‡¶ñ‡¶® ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø 'admin'
        cp -r admin/* temp_deploy/admin/
        cp -r api/* temp_deploy/api/
        
        # ‡ß™. ‡¶∞‡ßÅ‡¶ü‡ßá‡¶∞ ‡¶™‡¶ø‡¶è‡¶á‡¶ö‡¶™‡¶ø ‡¶´‡¶æ‡¶á‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ (db.php, auth.php ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø)
        cp *.php temp_deploy/ 2>/dev/null || :
        
        # ‡ß´. ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ uploads ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)
        cp -r uploads/* temp_deploy/uploads/ 2>/dev/null || :
        
        echo "‚úÖ Files ready for upload!"

    - name: üöÄ Upload to cPanel
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./temp_deploy/
        server-dir: /
        protocol: ftps
        exclude: |
          **/.git*
          **/node_modules/**
          backups/**
          error_log
          # ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶ì‡¶≠‡¶æ‡¶∞‡¶∞‡¶æ‡¶á‡¶ü ‡¶®‡¶æ ‡¶π‡ßü (‡¶Ø‡¶¶‡¶ø ‡¶ö‡¶æ‡¶®)
          # uploads/**