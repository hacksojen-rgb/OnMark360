name: ЁЯЪА Auto Deploy to cPanel

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ЁЯОЙ Build & Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ЁЯЪЪ Get latest code
      uses: actions/checkout@v4

    - name: ЁЯЯв Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # ЁЯФе ржлрж┐ржХрзНрж╕: ржПржЦрж╛ржирзЗ npm ci ржПрж░ ржмржжрж▓рзЗ --legacy-peer-deps ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ
    - name: ЁЯУж Install Dependencies
      run: npm install --legacy-peer-deps

    - name: ЁЯПЧя╕П Build Frontend
      run: npm run build
      env:
        CI: false

    - name: ЁЯУВ Prepare Files for Deployment
      run: |
        mkdir temp_deploy
        
        # рзз. ржлрзНрж░ржирзНржЯржПржирзНржбрзЗрж░ ржмрж┐рж▓рзНржб ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ (dist ржерзЗржХрзЗ) рж░рзБржЯрзЗ ржЖржирж╛
        cp -r dist/* temp_deploy/
        
        # рзи. ржмрзНржпрж╛ржХржПржирзНржбрзЗрж░ ржлрзЛрж▓рзНржбрж╛рж░ржЧрзБрж▓рзЛ рждрзИрж░рж┐ ржХрж░рж╛
        mkdir -p temp_deploy/admin
        mkdir -p temp_deploy/api
        mkdir -p temp_deploy/uploads
        
        # рзй. ржмрзНржпрж╛ржХржПржирзНржб ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ ржХржкрж┐ ржХрж░рж╛
        # ржпржжрж┐ admin/api ржлрзЛрж▓рзНржбрж╛рж░ ржерж╛ржХрзЗ рждржмрзЗ ржХржкрж┐ рж╣ржмрзЗ
        if [ -d "admin" ]; then cp -r admin/* temp_deploy/admin/; fi
        if [ -d "api" ]; then cp -r api/* temp_deploy/api/; fi
        
        # рзк. рж░рзБржЯрзЗрж░ ржкрж┐ржПржЗржЪржкрж┐ ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ ржХржкрж┐ ржХрж░рж╛
        # find ржХржорж╛ржирзНржб ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ ржпрж╛рждрзЗ ржлрж╛ржЗрж▓ ржирж╛ ржерж╛ржХрж▓рзЗ ржПрж░рж░ ржирж╛ ржжрзЗрзЯ
        find . -maxdepth 1 -name "*.php" -exec cp {} temp_deploy/ \;
        
        # рзл. рж▓рзЛржХрж╛рж▓ uploads ржлрзЛрж▓рзНржбрж╛рж░ ржерж╛ржХрж▓рзЗ ржХржкрж┐ ржХрж░рж╛ (ржЕржкрж╢ржирж╛рж▓)
        if [ -d "uploads" ]; then cp -r uploads/* temp_deploy/uploads/; fi
        
        echo "тЬЕ Files ready for upload!"

    - name: ЁЯЪА Upload to cPanel
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./temp_deploy/
        server-dir: /
        protocol: ftps
        exclude: |
          **/.git*
          **/node_modules/**
          backups/**
          error_log
          # рж╕рж╛рж░рзНржнрж╛рж░рзЗрж░ ржЖржкрж▓рзЛржб ржлрзЛрж▓рзНржбрж╛рж░ ржпрж╛рждрзЗ ржУржнрж╛рж░рж░рж╛ржЗржЯ ржирж╛ рж╣рзЯ (ржирж┐ржЪрзЗрж░ рж▓рж╛ржЗржиржЯрж┐ ржЖржиржХржорзЗржирзНржЯ ржХрж░рждрзЗ ржкрж╛рж░рзЗржи ржпржжрж┐ ржЪрж╛ржи)
          # uploads/**