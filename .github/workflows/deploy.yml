name: ЁЯЪА Auto Deploy to cPanel

on:
  push:
    branches:
      - main  # ржЖржкржирж╛рж░ ржорзЗржЗржи ржмрзНрж░рж╛ржЮрзНржЪрзЗрж░ ржирж╛ржо ржпржжрж┐ 'master' рж╣ржпрж╝ рждржмрзЗ ржПржЦрж╛ржирзЗ 'master' ржжрж┐ржи

jobs:
  web-deploy:
    name: ЁЯОЙ Build & Deploy
    runs-on: ubuntu-latest
    
    steps:
    # рзз. рж▓рзЗржЯрзЗрж╕рзНржЯ ржХрзЛржб ржЪрзЗржХржЖржЙржЯ ржХрж░рж╛
    - name: ЁЯЪЪ Get latest code
      uses: actions/checkout@v4

    # рзи. Node.js рж╕рзЗржЯржЖржк ржХрж░рж╛
    - name: ЁЯЯв Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # рзй. ржбрж┐ржкрзЗржирзНржбрзЗржирзНрж╕рж┐ ржЗржирзНрж╕ржЯрж▓ ржХрж░рж╛
    - name: ЁЯУж Install Dependencies
      run: npm ci

    # рзк. React ржЕрзНржпрж╛ржк ржмрж┐рж▓рзНржб ржХрж░рж╛ (dist ржлрзЛрж▓рзНржбрж╛рж░ рждрзИрж░рж┐ рж╣ржмрзЗ)
    - name: ЁЯПЧя╕П Build Frontend
      run: npm run build

    # рзл. рж╕рзНржорж╛рж░рзНржЯ ржлрж╛ржЗрж▓ ржЕрж░рзНржЧрж╛ржирж╛ржЗржЬрзЗрж╢ржи (ржЦрзБржмржЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржзрж╛ржк)
    # ржЖржорж░рж╛ ржПржХржЯрж┐ 'temp_deploy' ржлрзЛрж▓рзНржбрж╛рж░ ржмрж╛ржирж╛ржмрзЛ ржпрзЗржЦрж╛ржирзЗ рж╢рзБржзрзБ рж▓рж╛ржЗржнрзЗ ржпрж╛ржУржпрж╝рж╛рж░ ржпрзЛржЧрзНржп ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ рж░рж╛ржЦржмрзЛ
    - name: ЁЯУВ Prepare Files for Deployment
      run: |
        mkdir temp_deploy
        
        # рзз. ржлрзНрж░ржирзНржЯржПржирзНржбрзЗрж░ ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ (dist ржерзЗржХрзЗ) рж░рзБржЯрзЗ ржЖржирж╛
        cp -r dist/* temp_deploy/
        
        # рзи. ржмрзНржпрж╛ржХржПржирзНржбрзЗрж░ ржлрзЛрж▓рзНржбрж╛рж░ржЧрзБрж▓рзЛ (admin, api, uploads, etc) ржХржкрж┐ ржХрж░рж╛
        # ржирзЛржЯ: uploads ржлрзЛрж▓рзНржбрж╛рж░ ржЖржорж░рж╛ рж▓рж╛ржЗржнрзЗ ржУржнрж╛рж░рж░рж╛ржЗржЯ ржХрж░ржмрзЛ ржирж╛, рждрж╛ржЗ ржмрж╛ржж рж░рж╛ржЦрж▓рж╛ржо
        mkdir -p temp_deploy/admin
        mkdir -p temp_deploy/api
        
        # рзй. рж╕рзЛрж░рзНрж╕ ржерзЗржХрзЗ ржкрж┐ржПржЗржЪржкрж┐ ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ рж╕ржарж┐ржХ ржЬрж╛ржпрж╝ржЧрж╛ржпрж╝ ржирзЗржУржпрж╝рж╛
        # ржЖржкржирж╛рж░ src ржлрзЛрж▓рзНржбрж╛рж░рзЗрж░ ржЧржаржи ржЕржирзБржпрж╛ржпрж╝рзА:
        cp -r src/admin/* temp_deploy/admin/
        cp -r src/api/* temp_deploy/api/
        
        # рзк. рж░рзБржЯрзЗрж░ ржкрж┐ржПржЗржЪржкрж┐ ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ (db.php, auth.php, layout files)
        # ржПржЧрзБрж▓рзЛ src ржлрзЛрж▓рзНржбрж╛рж░рзЗ ржЖржЫрзЗ, ржХрж┐ржирзНрждрзБ рж╕рж╛рж░рзНржнрж╛рж░рзЗ рж░рзБржЯрзЗ ржмрж╛ ржкрзНржпрж╛рж░рзЗржирзНржЯ ржлрзЛрж▓рзНржбрж╛рж░рзЗ рж▓рж╛ржЧржмрзЗ
        # ржЖржкржирж╛рж░ ржмрж░рзНрждржорж╛ржи рж╕рзЗржЯржЖржк ржЕржирзБржпрж╛рзЯрзА ржПржЧрзБрж▓рзЛ рж░рзБржЯрзЗ ржХржкрж┐ ржХрж░ржЫрж┐
        cp src/*.php temp_deploy/ 2>/dev/null || :
        
        echo "тЬЕ Files ready for upload!"

    # рзм. рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржЖржкрж▓рзЛржб ржХрж░рж╛ (FTP)
    - name: ЁЯЪА Upload to cPanel
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./temp_deploy/
        server-dir: /  # рж╕рж╛ржмржбрзЛржорзЗржЗржи рж╣рж▓рзЗ ржкрж╛рже ржкрж╛рж▓рзНржЯрж╛рждрзЗ рж╣рждрзЗ ржкрж╛рж░рзЗ (ржпрзЗржоржи: /agency.domain.com/)
        protocol: ftps
        # рж╕рж╛рж░рзНржнрж╛рж░рзЗрж░ uploads ржмрж╛ backups ржлрзЛрж▓рзНржбрж╛рж░ ржпрж╛рждрзЗ ржбрж┐рж▓рж┐ржЯ ржирж╛ рж╣рзЯ рждрж╛рж░ ржЬржирзНржп exclude
        exclude: |
          **/.git*
          **/node_modules/**
          backups/**
          uploads/**
          error_log